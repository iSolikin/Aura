<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aura ‚Äì —Ç—Ä–µ–∫–µ—Ä —Å–Ω–∞ –∏ –≤–µ—Å–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .app {
            max-width: 520px;
            margin: 0 auto;
            padding: 12px;
            padding-bottom: 80px;
        }

        h1 {
            font-size: 26px;
            margin: 16px 0 8px 0;
            text-align: center;
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 12px;
            border-radius: 10px;
            overflow: hidden;
            background: #16213e;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: none;
            background-color: transparent;
            color: #999;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            color: #000;
            font-weight: 600;
        }

        .card {
            background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .card-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #00d4ff;
            font-size: 15px;
        }

        .field {
            margin-bottom: 12px;
        }

        .field label {
            display: block;
            font-size: 12px;
            margin-bottom: 6px;
            color: #aaa;
            font-weight: 500;
        }

        .field input,
        .field textarea,
        .field select {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            background-color: rgba(15, 15, 35, 0.8);
            color: #e0e0e0;
            outline: none;
            transition: border-color 0.2s;
        }

        .field input:focus,
        .field textarea:focus {
            border-color: #00d4ff;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.2);
        }

        .field textarea {
            resize: vertical;
            min-height: 70px;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .status {
            font-size: 13px;
            margin-bottom: 12px;
            color: #aaa;
            padding: 10px 12px;
            border-radius: 8px;
            background: rgba(0, 212, 255, 0.1);
            border-left: 3px solid #00d4ff;
        }

        .status.ok {
            color: #4ade80;
            border-left-color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
        }

        .status.err {
            color: #ff4444;
            border-left-color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
        }

        .list-item {
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            font-size: 13px;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-label {
            font-weight: 600;
            color: #00d4ff;
        }

        .small {
            font-size: 12px;
            color: #777;
            margin-top: 4px;
        }

        .nav-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(15, 15, 35, 0.8) 0%, rgba(15, 15, 35, 1) 100%);
            border-top: 1px solid rgba(0, 212, 255, 0.2);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            max-width: 520px;
            margin: 0 auto;
        }

        .nav-item {
            flex: 1;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            font-size: 12px;
            color: #777;
            transition: all 0.2s;
        }

        .nav-item.active {
            color: #00d4ff;
        }

        .calc-result {
            background: rgba(0, 212, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            text-align: center;
        }

        .calc-result-value {
            font-size: 20px;
            color: #00d4ff;
            font-weight: 700;
        }

        .calc-result-label {
            font-size: 12px;
            color: #aaa;
            margin-top: 4px;
        }
    </style>
</head>
<body>
<div class="app">
    <h1>üåô Aura</h1>

    <!-- –°–¢–ê–¢–£–° -->
    <div class="status" id="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>

    <!-- –ë–õ–û–ö –ì–õ–ê–í–ù–û–ô -->
    <div class="tab-panel" id="tab-home">
        <div class="card">
            <div class="card-title">üìä –°–µ–≥–æ–¥–Ω—è</div>
            <div id="today-sleep" class="list-item">–°–æ–Ω: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
            <div id="today-weight" class="list-item">–í–µ—Å: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
        </div>

        <div class="card">
            <div class="card-title">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
            <button class="btn-primary" onclick="switchTab('sleep')" style="margin-bottom: 8px;">üåô –ó–∞–ø–∏—Å–∞—Ç—å —Å–æ–Ω</button>
            <button class="btn-primary" onclick="switchTab('weight')">‚öñÔ∏è –ó–∞–ø–∏—Å–∞—Ç—å –≤–µ—Å</button>
        </div>
    </div>

    <!-- –ë–õ–û–ö –°–ù–ê -->
    <div class="tab-panel" id="tab-sleep" style="display:none;">
        <div class="card">
            <div class="card-title">üåô –¢—Ä–µ–∫–µ—Ä —Å–Ω–∞</div>

            <div class="field">
                <label for="sleep-date">–î–∞—Ç–∞</label>
                <input type="date" id="sleep-date" />
            </div>

            <div class="field">
                <label for="sleep-start">–í—Ä–µ–º—è –∑–∞—Å—ã–ø–∞–Ω–∏—è</label>
                <input type="time" id="sleep-start" />
            </div>

            <div class="field">
                <label for="sleep-end">–í—Ä–µ–º—è –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è</label>
                <input type="time" id="sleep-end" />
            </div>

            <div id="sleep-calc" style="display:none;">
                <div class="calc-result">
                    <div class="calc-result-label">–°–ø–∞–ª</div>
                    <div class="calc-result-value" id="sleep-hours-calc">‚Äî</div>
                    <div class="calc-result-label">–ö–∞—á–µ—Å—Ç–≤–æ</div>
                    <div class="calc-result-value" id="sleep-quality-calc">‚Äî</div>
                </div>
            </div>

            <div class="field">
                <label for="sleep-notes">–ó–∞–º–µ—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <textarea id="sleep-notes" placeholder="–ö–∞–∫ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª —Å–µ–±—è, –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–æ —Å–Ω–æ–º..."></textarea>
            </div>

            <button class="btn-primary" id="btn-save-sleep">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–Ω</button>
        </div>
    </div>

    <!-- –ë–õ–û–ö –í–ï–°–ê -->
    <div class="tab-panel" id="tab-weight" style="display:none;">
        <div class="card">
            <div class="card-title">‚öñÔ∏è –¢—Ä–µ–∫–µ—Ä –≤–µ—Å–∞</div>

            <div class="field">
                <label for="weight-date">–î–∞—Ç–∞</label>
                <input type="date" id="weight-date" />
            </div>

            <div class="field">
                <label for="weight-value">–í–µ—Å (–∫–≥)</label>
                <input type="number" id="weight-value" min="0" max="300" step="0.1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 72.4" />
            </div>

            <div class="field">
                <label for="weight-notes">–ó–∞–º–µ—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <textarea id="weight-notes" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏..."></textarea>
            </div>

            <button class="btn-primary" id="btn-save-weight">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—Å</button>
        </div>
    </div>

    <!-- –ë–õ–û–ö –ò–°–¢–û–†–ò–ò -->
    <div class="tab-panel" id="tab-history" style="display:none;">
        <div class="card">
            <div class="card-title">üìà –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 7 –¥–Ω–µ–π</div>
            <div class="small">–°–æ–Ω:</div>
            <div id="sleep-list"></div>
            <div style="margin-top: 12px;">
                <div class="small">–í–µ—Å:</div>
                <div id="weight-list"></div>
            </div>
        </div>
    </div>

</div>

<!-- –ù–ò–ñ–ù–Ø–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
<div class="nav-bottom">
    <div class="nav-item active" data-tab="home" onclick="navClick(this)">üè† –ì–ª–∞–≤–Ω–∞—è</div>
    <div class="nav-item" data-tab="sleep" onclick="navClick(this)">üåô –°–æ–Ω</div>
    <div class="nav-item" data-tab="weight" onclick="navClick(this)">‚öñÔ∏è –í–µ—Å</div>
    <div class="nav-item" data-tab="history" onclick="navClick(this)">üìà –ò—Å—Ç–æ—Ä–∏—è</div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    let telegramId = null;

    function setStatus(msg, type = '') {
        const el = document.getElementById('status');
        el.textContent = msg;
        el.className = 'status ' + (type || '');
    }

    function initUser() {
        try {
            const user = tg.initDataUnsafe?.user;
            if (!user) {
                setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'err');
                return;
            }
            telegramId = user.id;
            setStatus('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ' + (user.first_name || '–¥—Ä—É–∂–µ') + '! üëã', 'ok');
        } catch (e) {
            console.error(e);
            setStatus('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏', 'err');
        }
    }

    function isoDateToday() {
        const d = new Date();
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function switchTab(name) {
        document.querySelectorAll('.tab-panel').forEach(p => {
            p.style.display = p.id === 'tab-' + name ? 'block' : 'none';
        });
        document.querySelectorAll('.nav-item').forEach(n => {
            n.classList.toggle('active', n.dataset.tab === name);
        });
    }

    function navClick(el) {
        switchTab(el.dataset.tab);
    }

    async function postJson(path, body) {
        const res = await fetch(path, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        return res.json();
    }

    async function loadTodaySummary() {
        if (!telegramId) return;
        try {
            const res = await fetch(`/api/dashboard/${telegramId}`);
            const json = await res.json();

            if (!json.ok) return;

            const today = isoDateToday();
            const todaySleep = json.sleep?.find(s => s.date === today);
            const todayWeight = json.weight?.find(w => w.date === today);

            const sleepDiv = document.getElementById('today-sleep');
            const weightDiv = document.getElementById('today-weight');

            if (todaySleep) {
                sleepDiv.innerHTML = `<span class="list-label">üåô –°–æ–Ω:</span> ${todaySleep.hours_slept} —á, –∫–∞—á–µ—Å—Ç–≤–æ ${todaySleep.quality_rating}/10`;
            }

            if (todayWeight) {
                weightDiv.innerHTML = `<span class="list-label">‚öñÔ∏è –í–µ—Å:</span> ${todayWeight.weight_kg} –∫–≥`;
            }
        } catch (e) {
            console.error('loadTodaySummary error:', e);
        }
    }

    async function loadHistory() {
        if (!telegramId) return;
        try {
            const res = await fetch(`/api/dashboard/${telegramId}`);
            const json = await res.json();

            if (!json.ok) return;

            const sleepList = document.getElementById('sleep-list');
            const weightList = document.getElementById('weight-list');
            sleepList.innerHTML = '';
            weightList.innerHTML = '';

            if (json.sleep && json.sleep.length) {
                json.sleep.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <span class="list-label">${item.date}</span> ‚Äì 
                        ${item.hours_slept} —á, –∫–∞—á–µ—Å—Ç–≤–æ ${item.quality_rating}/10
                        ${item.notes ? `<div class="small">${item.notes}</div>` : ''}
                    `;
                    sleepList.appendChild(div);
                });
            } else {
                sleepList.innerHTML = '<div class="small">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            }

            if (json.weight && json.weight.length) {
                json.weight.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <span class="list-label">${item.date}</span> ‚Äì 
                        ${item.weight_kg} –∫–≥
                        ${item.notes ? `<div class="small">${item.notes}</div>` : ''}
                    `;
                    weightList.appendChild(div);
                });
            } else {
                weightList.innerHTML = '<div class="small">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            }

        } catch (e) {
            console.error('loadHistory error:', e);
        }
    }

    // –†–∞—Å—á–µ—Ç —Å–Ω–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ –≤—Ä–µ–º—ë–Ω
    function calcSleep() {
        const start = document.getElementById('sleep-start').value;
        const end = document.getElementById('sleep-end').value;

        if (!start || !end) {
            document.getElementById('sleep-calc').style.display = 'none';
            return;
        }

        const [startH, startM] = start.split(':').map(Number);
        const [endH, endM] = end.split(':').map(Number);

        let startMinutes = startH * 60 + startM;
        let endMinutes = endH * 60 + endM;

        if (endMinutes <= startMinutes) {
            endMinutes += 24 * 60;
        }

        const hours = parseFloat(((endMinutes - startMinutes) / 60).toFixed(1));

        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ (–∫–æ–ø–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É –∏–∑ –±–æ—Ç–∞)
        let quality = 5;
        if (hours >= 7 && hours <= 9) {
            quality = 8;
        } else if (hours >= 6 && hours < 7) {
            quality = 6;
        } else if (hours > 9 && hours <= 10) {
            quality = 7;
        } else if (hours <= 5) {
            quality = 3;
        }

        if (startH >= 1 && startH < 6) {
            quality = Math.max(1, quality - 2);
        }

        quality = Math.max(1, Math.min(10, quality));

        document.getElementById('sleep-hours-calc').textContent = hours + ' —á–∞—Å–æ–≤';
        document.getElementById('sleep-quality-calc').textContent = quality + '/10';
        document.getElementById('sleep-calc').style.display = 'block';
    }

    document.addEventListener('DOMContentLoaded', () => {
        tg.ready();
        initUser();

        document.getElementById('sleep-date').value = isoDateToday();
        document.getElementById('weight-date').value = isoDateToday();

        document.getElementById('sleep-start').addEventListener('change', calcSleep);
        document.getElementById('sleep-end').addEventListener('change', calcSleep);

        document.getElementById('btn-save-sleep').addEventListener('click', async () => {
            if (!telegramId) {
                setStatus('–ù–µ—Ç telegramId', 'err');
                return;
            }
            const date = document.getElementById('sleep-date').value;
            const sleepStart = document.getElementById('sleep-start').value;
            const sleepEnd = document.getElementById('sleep-end').value;
            const notes = document.getElementById('sleep-notes').value.trim();

            if (!date || !sleepStart || !sleepEnd) {
                setStatus('–£–∫–∞–∂–∏ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –∑–∞—Å—ã–ø–∞–Ω–∏—è/–ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è', 'err');
                return;
            }

            setStatus('–°–æ—Ö—Ä–∞–Ω—è—é —Å–æ–Ω...', '');
            try {
                const json = await postJson('/api/sleep', {
                    telegramId,
                    date,
                    sleepStart,
                    sleepEnd,
                    notes
                });
                if (json.ok) {
                    setStatus(`–°–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω! ${json.calculated.hours}—á, –∫–∞—á–µ—Å—Ç–≤–æ ${json.calculated.quality}/10 ‚úÖ`, 'ok');
                    loadTodaySummary();
                    tg.HapticFeedback?.notificationOccurred('success');
                } else {
                    setStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–Ω–∞', 'err');
                    tg.HapticFeedback?.notificationOccurred('error');
                }
            } catch (e) {
                console.error(e);
                setStatus('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'err');
            }
        });

        document.getElementById('btn-save-weight').addEventListener('click', async () => {
            if (!telegramId) {
                setStatus('–ù–µ—Ç telegramId', 'err');
                return;
            }
            const date = document.getElementById('weight-date').value;
            const weight = parseFloat(document.getElementById('weight-value').value);
            const notes = document.getElementById('weight-notes').value.trim();

            if (!date || isNaN(weight)) {
                setStatus('–£–∫–∞–∂–∏ –¥–∞—Ç—É –∏ –≤–µ—Å', 'err');
                return;
            }

            setStatus('–°–æ—Ö—Ä–∞–Ω—è—é –≤–µ—Å...', '');
            try {
                const json = await postJson('/api/weight', {
                    telegramId,
                    date,
                    weight,
                    notes
                });
                if (json.ok) {
                    setStatus(`–í–µ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω ${weight} –∫–≥ ‚úÖ`, 'ok');
                    loadTodaySummary();
                    tg.HapticFeedback?.notificationOccurred('success');
                } else {
                    setStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–µ—Å–∞', 'err');
                    tg.HapticFeedback?.notificationOccurred('error');
                }
            } catch (e) {
                console.error(e);
                setStatus('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'err');
            }
        });

        loadTodaySummary();
    });
</script>
</body>
</html>
