<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aura ‚Äì —Ç—Ä–µ–∫–µ—Ä —Å–Ω–∞ –∏ –≤–µ—Å–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #111;
        }

        .app {
            max-width: 520px;
            margin: 0 auto;
            padding: 16px;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 12px;
            text-align: center;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            border: 1px solid #ccc;
            background-color: #fff;
            cursor: pointer;
            font-size: 14px;
        }

        .tab.active {
            background-color: #0088cc;
            color: #fff;
            border-color: #0088cc;
        }

        .card {
            background-color: #fff;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .card-title {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .field {
            margin-bottom: 10px;
        }

        .field label {
            display: block;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .field input,
        .field textarea,
        .field select {
            width: 100%;
            padding: 8px 10px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #ccc;
            outline: none;
        }

        .field textarea {
            resize: vertical;
            min-height: 60px;
        }

        .btn-primary {
            width: 100%;
            padding: 10px;
            background-color: #0088cc;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary:active {
            opacity: 0.8;
        }

        .status {
            font-size: 13px;
            margin-bottom: 8px;
            color: #555;
        }

        .status.ok {
            color: #2e7d32;
        }

        .status.err {
            color: #c62828;
        }

        .list-item {
            padding: 6px 0;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-label {
            font-weight: 600;
        }

        .small {
            font-size: 12px;
            color: #777;
        }
    </style>
</head>
<body>
<div class="app">
    <h1>üëã Aura ‚Äì —Ç—Ä–µ–∫–µ—Ä</h1>

    <div class="tabs">
        <div class="tab active" data-tab="sleep">–°–æ–Ω</div>
        <div class="tab" data-tab="weight">–í–µ—Å</div>
        <div class="tab" data-tab="dashboard">–î–∞—à–±–æ—Ä–¥</div>
    </div>

    <!-- –°–¢–ê–¢–£–° -->
    <div class="status" id="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>

    <!-- –ë–õ–û–ö –°–ù–ê -->
    <div class="card tab-panel" id="tab-sleep">
        <div class="card-title">–ó–∞–ø–∏—Å–∞—Ç—å —Å–æ–Ω –∑–∞ –¥–µ–Ω—å</div>

        <div class="field">
            <label for="sleep-date">–î–∞—Ç–∞</label>
            <input type="date" id="sleep-date" />
        </div>

        <div class="field">
            <label for="sleep-hours">–ß–∞—Å—ã —Å–Ω–∞</label>
            <input type="number" id="sleep-hours" min="0" max="24" step="0.5" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 7.5" />
        </div>

        <div class="field">
            <label for="sleep-quality">–ö–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞ (1‚Äì10)</label>
            <input type="number" id="sleep-quality" min="1" max="10" step="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 8" />
        </div>

        <div class="field">
            <label for="sleep-notes">–ó–∞–º–µ—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <textarea id="sleep-notes" placeholder="–í–æ —Å–∫–æ–ª—å–∫–æ –ª—ë–≥ / –≤–æ —Å–∫–æ–ª—å–∫–æ –≤—Å—Ç–∞–ª, –∫–∞–∫ —á—É–≤—Å—Ç–≤–æ–≤–∞–ª —Å–µ–±—è —É—Ç—Ä–æ–º..."></textarea>
        </div>

        <button class="btn-primary" id="btn-save-sleep">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–Ω</button>
    </div>

    <!-- –ë–õ–û–ö –í–ï–°–ê -->
    <div class="card tab-panel" id="tab-weight" style="display:none;">
        <div class="card-title">–ó–∞–ø–∏—Å–∞—Ç—å –≤–µ—Å –∑–∞ –¥–µ–Ω—å</div>

        <div class="field">
            <label for="weight-date">–î–∞—Ç–∞</label>
            <input type="date" id="weight-date" />
        </div>

        <div class="field">
            <label for="weight-value">–í–µ—Å (–∫–≥)</label>
            <input type="number" id="weight-value" min="0" max="300" step="0.1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 72.4" />
        </div>

        <div class="field">
            <label for="weight-notes">–ó–∞–º–µ—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <textarea id="weight-notes" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–∞—Ü–∏–æ–Ω–µ –∏–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö"></textarea>
        </div>

        <button class="btn-primary" id="btn-save-weight">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—Å</button>
    </div>

    <!-- –î–ê–®–ë–û–†–î -->
    <div class="card tab-panel" id="tab-dashboard" style="display:none;">
        <div class="card-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</div>
        <div class="field">
            <div class="small">–°–æ–Ω:</div>
            <div id="sleep-list"></div>
        </div>

        <div class="field">
            <div class="small">–í–µ—Å:</div>
            <div id="weight-list"></div>
        </div>
    </div>

</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    let telegramId = null;

    function setStatus(msg, type = '') {
        const el = document.getElementById('status');
        el.textContent = msg;
        el.className = 'status ' + (type || '');
    }

    function initUser() {
        try {
            const user = tg.initDataUnsafe?.user;
            if (!user) {
                setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram', 'err');
                return;
            }
            telegramId = user.id;
            setStatus('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ' + (user.username || user.first_name), 'ok');
        } catch (e) {
            console.error(e);
            setStatus('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ WebApp', 'err');
        }
    }

    function isoDateToday() {
        const d = new Date();
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function switchTab(name) {
        document.querySelectorAll('.tab').forEach(t => {
            t.classList.toggle('active', t.dataset.tab === name);
        });
        document.querySelectorAll('.tab-panel').forEach(p => {
            p.style.display = p.id === 'tab-' + name ? 'block' : 'none';
        });
    }

    async function postJson(path, body) {
        const res = await fetch(path, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        return res.json();
    }

    async function loadDashboard() {
        if (!telegramId) return;
        try {
            const res = await fetch(`/api/dashboard/${telegramId}`);
            const json = await res.json();

            if (!json.ok) {
                setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞', 'err');
                console.error(json);
                return;
            }

            const sleepList = document.getElementById('sleep-list');
            const weightList = document.getElementById('weight-list');
            sleepList.innerHTML = '';
            weightList.innerHTML = '';

            if (json.sleep && json.sleep.length) {
                json.sleep.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <span class="list-label">${item.date}</span> ‚Äì 
                        ${item.hours_slept} —á, –∫–∞—á–µ—Å—Ç–≤–æ ${item.quality_rating ?? '-'}
                        ${item.notes ? `<div class="small">${item.notes}</div>` : ''}
                    `;
                    sleepList.appendChild(div);
                });
            } else {
                sleepList.innerHTML = '<div class="small">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            }

            if (json.weight && json.weight.length) {
                json.weight.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <span class="list-label">${item.date}</span> ‚Äì 
                        ${item.weight_kg} –∫–≥
                        ${item.notes ? `<div class="small">${item.notes}</div>` : ''}
                    `;
                    weightList.appendChild(div);
                });
            } else {
                weightList.innerHTML = '<div class="small">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            }

        } catch (e) {
            console.error(e);
            setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞', 'err');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        tg.ready();
        initUser();

        document.getElementById('sleep-date').value = isoDateToday();
        document.getElementById('weight-date').value = isoDateToday();

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const name = tab.dataset.tab;
                switchTab(name);
                if (name === 'dashboard') {
                    loadDashboard();
                }
            });
        });

        document.getElementById('btn-save-sleep').addEventListener('click', async () => {
            if (!telegramId) {
                setStatus('–ù–µ—Ç telegramId, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞', 'err');
                return;
            }
            const date = document.getElementById('sleep-date').value;
            const hours = parseFloat(document.getElementById('sleep-hours').value);
            const quality = parseInt(document.getElementById('sleep-quality').value || '0', 10);
            const notes = document.getElementById('sleep-notes').value.trim();

            if (!date || isNaN(hours)) {
                setStatus('–£–∫–∞–∂–∏ –¥–∞—Ç—É –∏ —á–∞—Å—ã —Å–Ω–∞', 'err');
                return;
            }

            setStatus('–°–æ—Ö—Ä–∞–Ω—è—é —Å–æ–Ω...', '');
            try {
                const json = await postJson('/api/sleep', {
                    telegramId,
                    date,
                    hours,
                    quality: quality || null,
                    notes
                });
                if (json.ok) {
                    setStatus('–°–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'ok');
                    tg.HapticFeedback?.notificationOccurred('success');
                } else {
                    console.error(json);
                    setStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–Ω–∞', 'err');
                    tg.HapticFeedback?.notificationOccurred('error');
                }
            } catch (e) {
                console.error(e);
                setStatus('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–Ω–∞', 'err');
            }
        });

        document.getElementById('btn-save-weight').addEventListener('click', async () => {
            if (!telegramId) {
                setStatus('–ù–µ—Ç telegramId, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞', 'err');
                return;
            }
            const date = document.getElementById('weight-date').value;
            const weight = parseFloat(document.getElementById('weight-value').value);
            const notes = document.getElementById('weight-notes').value.trim();

            if (!date || isNaN(weight)) {
                setStatus('–£–∫–∞–∂–∏ –¥–∞—Ç—É –∏ –≤–µ—Å', 'err');
                return;
            }

            setStatus('–°–æ—Ö—Ä–∞–Ω—è—é –≤–µ—Å...', '');
            try {
                const json = await postJson('/api/weight', {
                    telegramId,
                    date,
                    weight,
                    notes
                });
                if (json.ok) {
                    setStatus('–í–µ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'ok');
                    tg.HapticFeedback?.notificationOccurred('success');
                } else {
                    console.error(json);
                    setStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–µ—Å–∞', 'err');
                    tg.HapticFeedback?.notificationOccurred('error');
                }
            } catch (e) {
                console.error(e);
                setStatus('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–µ—Å–∞', 'err');
            }
        });
    });
</script>
</body>
</html>
